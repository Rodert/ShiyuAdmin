{"version":3,"sources":["src/pages/system/menu/components/MenuForm.tsx","src/pages/system/menu/index.tsx"],"sourcesContent":["import { ProForm, ProFormText, ProFormSelect } from '@ant-design/pro-components';\r\nimport { Button, Modal } from 'antd';\r\nimport React, { useMemo } from 'react';\r\nimport type { CreateMenuRequest, Menu, UpdateMenuRequest } from '@/services/shiyu-api/menu';\r\n\r\ninterface MenuFormProps {\r\n  visible: boolean;\r\n  onCancel: () => void;\r\n  onSubmit: (values: CreateMenuRequest | UpdateMenuRequest) => void;\r\n  title: string;\r\n  initialValues?: Menu;\r\n}\r\n\r\nconst MenuForm: React.FC<MenuFormProps> = ({\r\n  visible,\r\n  onCancel,\r\n  onSubmit,\r\n  title,\r\n  initialValues,\r\n}) => {\r\n  const isEdit = !!initialValues;\r\n  \r\n  // 使用 useMemo 确保 initialValues 引用稳定\r\n  const memoizedInitialValues = useMemo(() => {\r\n    return initialValues ? { ...initialValues } : undefined;\r\n  }, [initialValues]);\r\n\r\n  return (\r\n    <Modal\r\n      title={title}\r\n      open={visible}\r\n      onCancel={onCancel}\r\n      footer={null}\r\n      width={600}\r\n    >\r\n      <ProForm\r\n        key={isEdit ? initialValues?.menu_code : 'create'}\r\n        initialValues={memoizedInitialValues}\r\n        onFinish={async (values) => {\r\n          onSubmit(values as CreateMenuRequest | UpdateMenuRequest);\r\n        }}\r\n        submitter={{\r\n          render: (props, doms) => {\r\n            return [\r\n              <Button key=\"cancel\" onClick={onCancel}>\r\n                取消\r\n              </Button>,\r\n              <Button key=\"submit\" type=\"primary\" onClick={() => props.form?.submit?.()}>\r\n                确定\r\n              </Button>,\r\n            ];\r\n          },\r\n        }}\r\n      >\r\n        {!isEdit && (\r\n          <>\r\n            <ProFormText\r\n              name=\"menu_code\"\r\n              label=\"菜单编码\"\r\n              rules={[{ required: true, message: '请输入菜单编码' }]}\r\n            />\r\n            <ProFormSelect\r\n              name=\"menu_type\"\r\n              label=\"菜单类型\"\r\n              rules={[{ required: true, message: '请选择菜单类型' }]}\r\n              options={[\r\n                { label: '目录', value: 'M' },\r\n                { label: '菜单', value: 'C' },\r\n                { label: '按钮', value: 'F' },\r\n              ]}\r\n            />\r\n          </>\r\n        )}\r\n        {isEdit && (\r\n          <ProFormSelect\r\n            name=\"menu_type\"\r\n            label=\"菜单类型\"\r\n            options={[\r\n              { label: '目录', value: 'M' },\r\n              { label: '菜单', value: 'C' },\r\n              { label: '按钮', value: 'F' },\r\n            ]}\r\n          />\r\n        )}\r\n        <ProFormText name=\"parent_code\" label=\"父菜单编码\" />\r\n        <ProFormText name=\"menu_name\" label=\"菜单名称\" />\r\n        <ProFormText name=\"perms\" label=\"权限标识\" />\r\n        <ProFormText name=\"path\" label=\"路径\" />\r\n        <ProFormText name=\"component\" label=\"组件\" />\r\n        <ProFormSelect\r\n          name=\"status\"\r\n          label=\"状态\"\r\n          options={[\r\n            { label: '启用', value: 1 },\r\n            { label: '禁用', value: 0 },\r\n          ]}\r\n        />\r\n      </ProForm>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default MenuForm;\r\n\r\n","import { PlusOutlined } from '@ant-design/icons';\r\nimport type { ProColumns, ActionType } from '@ant-design/pro-components';\r\nimport { PageContainer, ProTable } from '@ant-design/pro-components';\r\nimport { Button, message, Modal, Space } from 'antd';\r\nimport React, { useRef, useState } from 'react';\r\nimport {\r\n  createMenu,\r\n  deleteMenu,\r\n  getMenuTree,\r\n  updateMenu,\r\n  type CreateMenuRequest,\r\n  type Menu,\r\n  type UpdateMenuRequest,\r\n} from '@/services/shiyu-api/menu';\r\nimport MenuForm from './components/MenuForm';\r\n\r\nconst MenuManagement: React.FC = () => {\r\n  const [createModalVisible, setCreateModalVisible] = useState(false);\r\n  const [updateModalVisible, setUpdateModalVisible] = useState(false);\r\n  const [editingRecord, setEditingRecord] = useState<Menu | null>(null);\r\n  const actionRef = useRef<ActionType>();\r\n\r\n  const handleCreate = async (values: CreateMenuRequest) => {\r\n    try {\r\n      const res = await createMenu(values);\r\n      if (res.code === 200) {\r\n        message.success('创建成功');\r\n        setCreateModalVisible(false);\r\n        actionRef.current?.reload();\r\n      } else {\r\n        message.error(res.message || '创建失败');\r\n      }\r\n    } catch (error) {\r\n      message.error('创建失败');\r\n    }\r\n  };\r\n\r\n  const handleUpdate = async (values: UpdateMenuRequest) => {\r\n    if (!editingRecord) return;\r\n    try {\r\n      const res = await updateMenu(editingRecord.menu_code, values);\r\n      if (res.code === 200) {\r\n        message.success('更新成功');\r\n        setUpdateModalVisible(false);\r\n        setEditingRecord(null);\r\n        actionRef.current?.reload();\r\n      } else {\r\n        message.error(res.message || '更新失败');\r\n      }\r\n    } catch (error) {\r\n      message.error('更新失败');\r\n    }\r\n  };\r\n\r\n  const handleDelete = (record: Menu) => {\r\n    Modal.confirm({\r\n      title: '确认删除',\r\n      content: `确定要删除菜单 \"${record.menu_name}\" 吗？`,\r\n      onOk: async () => {\r\n        try {\r\n          const res = await deleteMenu(record.menu_code);\r\n          if (res.code === 200) {\r\n            message.success('删除成功');\r\n            actionRef.current?.reload();\r\n          } else {\r\n            message.error(res.message || '删除失败');\r\n          }\r\n        } catch (error) {\r\n          message.error('删除失败');\r\n        }\r\n      },\r\n    });\r\n  };\r\n\r\n  const columns: ProColumns<Menu>[] = [\r\n    {\r\n      title: '菜单编码',\r\n      dataIndex: 'menu_code',\r\n      key: 'menu_code',\r\n      width: 120,\r\n    },\r\n    {\r\n      title: '菜单名称',\r\n      dataIndex: 'menu_name',\r\n      key: 'menu_name',\r\n      width: 150,\r\n    },\r\n    {\r\n      title: '菜单类型',\r\n      dataIndex: 'menu_type',\r\n      key: 'menu_type',\r\n      width: 100,\r\n      valueEnum: {\r\n        M: { text: '目录' },\r\n        C: { text: '菜单' },\r\n        F: { text: '按钮' },\r\n      },\r\n    },\r\n    {\r\n      title: '权限标识',\r\n      dataIndex: 'perms',\r\n      key: 'perms',\r\n      width: 150,\r\n    },\r\n    {\r\n      title: '路径',\r\n      dataIndex: 'path',\r\n      key: 'path',\r\n      width: 200,\r\n    },\r\n    {\r\n      title: '组件',\r\n      dataIndex: 'component',\r\n      key: 'component',\r\n      width: 200,\r\n    },\r\n    {\r\n      title: '状态',\r\n      dataIndex: 'status',\r\n      key: 'status',\r\n      width: 80,\r\n      valueEnum: {\r\n        1: { text: '启用', status: 'Success' },\r\n        0: { text: '禁用', status: 'Error' },\r\n      },\r\n    },\r\n    {\r\n      title: '操作',\r\n      key: 'action',\r\n      width: 180,\r\n      fixed: 'right',\r\n      render: (_, record) => (\r\n        <Space>\r\n          <Button\r\n            type=\"link\"\r\n            size=\"small\"\r\n            onClick={() => {\r\n              setEditingRecord(record);\r\n              setUpdateModalVisible(true);\r\n            }}\r\n          >\r\n            编辑\r\n          </Button>\r\n          <Button\r\n            type=\"link\"\r\n            size=\"small\"\r\n            danger\r\n            onClick={() => handleDelete(record)}\r\n          >\r\n            删除\r\n          </Button>\r\n        </Space>\r\n      ),\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <PageContainer>\r\n      <ProTable<Menu>\r\n        headerTitle=\"菜单管理\"\r\n        actionRef={actionRef}\r\n        rowKey=\"menu_code\"\r\n        search={false}\r\n        toolBarRender={() => [\r\n          <Button\r\n            type=\"primary\"\r\n            key=\"primary\"\r\n            onClick={() => {\r\n              setCreateModalVisible(true);\r\n            }}\r\n          >\r\n            <PlusOutlined /> 新建\r\n          </Button>,\r\n        ]}\r\n        request={async () => {\r\n          const res = await getMenuTree();\r\n          if (res.code === 200 && res.data) {\r\n            // Flatten tree for table display\r\n            const flatten = (menus: Menu[]): Menu[] => {\r\n              const result: Menu[] = [];\r\n              menus.forEach((menu) => {\r\n                result.push(menu);\r\n                if (menu.children && menu.children.length > 0) {\r\n                  result.push(...flatten(menu.children));\r\n                }\r\n              });\r\n              return result;\r\n            };\r\n            return {\r\n              data: flatten(res.data),\r\n              success: true,\r\n              total: flatten(res.data).length,\r\n            };\r\n          }\r\n          return {\r\n            data: [],\r\n            success: false,\r\n            total: 0,\r\n          };\r\n        }}\r\n        columns={columns}\r\n        pagination={false}\r\n      />\r\n\r\n      <MenuForm\r\n        visible={createModalVisible}\r\n        onCancel={() => setCreateModalVisible(false)}\r\n        onSubmit={handleCreate}\r\n        title=\"新建菜单\"\r\n      />\r\n\r\n      {editingRecord && (\r\n        <MenuForm\r\n          visible={updateModalVisible}\r\n          onCancel={() => {\r\n            setUpdateModalVisible(false);\r\n            setEditingRecord(null);\r\n          }}\r\n          onSubmit={handleUpdate}\r\n          title=\"编辑菜单\"\r\n          initialValues={editingRecord}\r\n        />\r\n      )}\r\n    </PageContainer>\r\n  );\r\n};\r\n\r\nexport default MenuManagement;\r\n\r\n"],"names":[],"mappings":"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"}