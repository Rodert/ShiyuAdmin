{"version":3,"sources":["src/services/shiyu-api/dept.ts","src/pages/system/dept/components/DeptForm.tsx","src/pages/system/dept/index.tsx"],"sourcesContent":["import { request } from '@umijs/max';\r\n\r\nexport interface Dept {\r\n  dept_code: string;\r\n  parent_code: string;\r\n  dept_name: string;\r\n  status: number;\r\n  children?: Dept[];\r\n}\r\n\r\nexport interface CreateDeptRequest {\r\n  dept_code: string;\r\n  parent_code?: string;\r\n  dept_name: string;\r\n  status?: number;\r\n}\r\n\r\nexport interface UpdateDeptRequest {\r\n  parent_code?: string;\r\n  dept_name?: string;\r\n  status?: number;\r\n}\r\n\r\n/** 获取部门列表 */\r\nexport async function getDeptList() {\r\n  return request<{\r\n    code: number;\r\n    data: Dept[];\r\n    message?: string;\r\n  }>('/api/v1/system/depts', {\r\n    method: 'GET',\r\n  });\r\n}\r\n\r\n/** 获取部门树 */\r\nexport async function getDeptTree() {\r\n  return request<{\r\n    code: number;\r\n    data: Dept[];\r\n    message?: string;\r\n  }>('/api/v1/system/depts/tree', {\r\n    method: 'GET',\r\n  });\r\n}\r\n\r\n/** 获取部门详情 */\r\nexport async function getDept(deptCode: string) {\r\n  return request<{\r\n    code: number;\r\n    data: Dept;\r\n    message?: string;\r\n  }>(`/api/v1/system/depts/${deptCode}`, {\r\n    method: 'GET',\r\n  });\r\n}\r\n\r\n/** 创建部门 */\r\nexport async function createDept(data: CreateDeptRequest) {\r\n  return request<{\r\n    code: number;\r\n    data: Dept;\r\n    message?: string;\r\n  }>('/api/v1/system/depts', {\r\n    method: 'POST',\r\n    data,\r\n  });\r\n}\r\n\r\n/** 更新部门 */\r\nexport async function updateDept(deptCode: string, data: UpdateDeptRequest) {\r\n  return request<{\r\n    code: number;\r\n    data: Dept;\r\n    message?: string;\r\n  }>(`/api/v1/system/depts/${deptCode}`, {\r\n    method: 'PUT',\r\n    data,\r\n  });\r\n}\r\n\r\n/** 删除部门 */\r\nexport async function deleteDept(deptCode: string) {\r\n  return request<{\r\n    code: number;\r\n    data: { deleted: boolean };\r\n    message?: string;\r\n  }>(`/api/v1/system/depts/${deptCode}`, {\r\n    method: 'DELETE',\r\n  });\r\n}\r\n\r\n","import { ProForm, ProFormText, ProFormSelect } from '@ant-design/pro-components';\r\nimport { Button, Modal } from 'antd';\r\nimport React, { useMemo } from 'react';\r\nimport type { CreateDeptRequest, Dept, UpdateDeptRequest } from '@/services/shiyu-api/dept';\r\n\r\ninterface DeptFormProps {\r\n  visible: boolean;\r\n  onCancel: () => void;\r\n  onSubmit: (values: CreateDeptRequest | UpdateDeptRequest) => void;\r\n  title: string;\r\n  initialValues?: Dept;\r\n}\r\n\r\nconst DeptForm: React.FC<DeptFormProps> = ({\r\n  visible,\r\n  onCancel,\r\n  onSubmit,\r\n  title,\r\n  initialValues,\r\n}) => {\r\n  const isEdit = !!initialValues;\r\n  \r\n  // 使用 useMemo 确保 initialValues 引用稳定\r\n  const memoizedInitialValues = useMemo(() => {\r\n    return initialValues ? { ...initialValues } : undefined;\r\n  }, [initialValues]);\r\n\r\n  return (\r\n    <Modal\r\n      title={title}\r\n      open={visible}\r\n      onCancel={onCancel}\r\n      footer={null}\r\n      width={600}\r\n    >\r\n      <ProForm\r\n        key={isEdit ? initialValues?.dept_code : 'create'}\r\n        initialValues={memoizedInitialValues}\r\n        onFinish={async (values) => {\r\n          onSubmit(values as CreateDeptRequest | UpdateDeptRequest);\r\n        }}\r\n        submitter={{\r\n          render: (props, doms) => {\r\n            return [\r\n              <Button key=\"cancel\" onClick={onCancel}>\r\n                取消\r\n              </Button>,\r\n              <Button key=\"submit\" type=\"primary\" onClick={() => props.form?.submit?.()}>\r\n                确定\r\n              </Button>,\r\n            ];\r\n          },\r\n        }}\r\n      >\r\n        {!isEdit && (\r\n          <ProFormText\r\n            name=\"dept_code\"\r\n            label=\"部门编码\"\r\n            rules={[{ required: true, message: '请输入部门编码' }]}\r\n          />\r\n        )}\r\n        <ProFormText name=\"parent_code\" label=\"父部门编码\" />\r\n        {!isEdit && (\r\n          <ProFormText\r\n            name=\"dept_name\"\r\n            label=\"部门名称\"\r\n            rules={[{ required: true, message: '请输入部门名称' }]}\r\n          />\r\n        )}\r\n        {isEdit && <ProFormText name=\"dept_name\" label=\"部门名称\" />}\r\n        <ProFormSelect\r\n          name=\"status\"\r\n          label=\"状态\"\r\n          options={[\r\n            { label: '启用', value: 1 },\r\n            { label: '禁用', value: 0 },\r\n          ]}\r\n        />\r\n      </ProForm>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default DeptForm;\r\n\r\n","import { PlusOutlined } from '@ant-design/icons';\r\nimport type { ProColumns, ActionType } from '@ant-design/pro-components';\r\nimport { PageContainer, ProTable } from '@ant-design/pro-components';\r\nimport { Button, message, Modal, Space } from 'antd';\r\nimport React, { useRef, useState } from 'react';\r\nimport {\r\n  createDept,\r\n  deleteDept,\r\n  getDeptTree,\r\n  updateDept,\r\n  type CreateDeptRequest,\r\n  type Dept,\r\n  type UpdateDeptRequest,\r\n} from '@/services/shiyu-api/dept';\r\nimport DeptForm from './components/DeptForm';\r\n\r\nconst DeptManagement: React.FC = () => {\r\n  const [createModalVisible, setCreateModalVisible] = useState(false);\r\n  const [updateModalVisible, setUpdateModalVisible] = useState(false);\r\n  const [editingRecord, setEditingRecord] = useState<Dept | null>(null);\r\n  const actionRef = useRef<ActionType>();\r\n\r\n  const handleCreate = async (values: CreateDeptRequest) => {\r\n    try {\r\n      const res = await createDept(values);\r\n      if (res.code === 200) {\r\n        message.success('创建成功');\r\n        setCreateModalVisible(false);\r\n        actionRef.current?.reload();\r\n      } else {\r\n        message.error(res.message || '创建失败');\r\n      }\r\n    } catch (error) {\r\n      message.error('创建失败');\r\n    }\r\n  };\r\n\r\n  const handleUpdate = async (values: UpdateDeptRequest) => {\r\n    if (!editingRecord) return;\r\n    try {\r\n      const res = await updateDept(editingRecord.dept_code, values);\r\n      if (res.code === 200) {\r\n        message.success('更新成功');\r\n        setUpdateModalVisible(false);\r\n        setEditingRecord(null);\r\n        actionRef.current?.reload();\r\n      } else {\r\n        message.error(res.message || '更新失败');\r\n      }\r\n    } catch (error) {\r\n      message.error('更新失败');\r\n    }\r\n  };\r\n\r\n  const handleDelete = (record: Dept) => {\r\n    Modal.confirm({\r\n      title: '确认删除',\r\n      content: `确定要删除部门 \"${record.dept_name}\" 吗？`,\r\n      onOk: async () => {\r\n        try {\r\n          const res = await deleteDept(record.dept_code);\r\n          if (res.code === 200) {\r\n            message.success('删除成功');\r\n            actionRef.current?.reload();\r\n          } else {\r\n            message.error(res.message || '删除失败');\r\n          }\r\n        } catch (error) {\r\n          message.error('删除失败');\r\n        }\r\n      },\r\n    });\r\n  };\r\n\r\n  const columns: ProColumns<Dept>[] = [\r\n    {\r\n      title: '部门编码',\r\n      dataIndex: 'dept_code',\r\n      key: 'dept_code',\r\n      width: 120,\r\n    },\r\n    {\r\n      title: '部门名称',\r\n      dataIndex: 'dept_name',\r\n      key: 'dept_name',\r\n      width: 200,\r\n    },\r\n    {\r\n      title: '父部门编码',\r\n      dataIndex: 'parent_code',\r\n      key: 'parent_code',\r\n      width: 120,\r\n    },\r\n    {\r\n      title: '状态',\r\n      dataIndex: 'status',\r\n      key: 'status',\r\n      width: 80,\r\n      valueEnum: {\r\n        1: { text: '启用', status: 'Success' },\r\n        0: { text: '禁用', status: 'Error' },\r\n      },\r\n    },\r\n    {\r\n      title: '操作',\r\n      key: 'action',\r\n      width: 180,\r\n      fixed: 'right',\r\n      render: (_, record) => (\r\n        <Space>\r\n          <Button\r\n            type=\"link\"\r\n            size=\"small\"\r\n            onClick={() => {\r\n              setEditingRecord(record);\r\n              setUpdateModalVisible(true);\r\n            }}\r\n          >\r\n            编辑\r\n          </Button>\r\n          <Button\r\n            type=\"link\"\r\n            size=\"small\"\r\n            danger\r\n            onClick={() => handleDelete(record)}\r\n          >\r\n            删除\r\n          </Button>\r\n        </Space>\r\n      ),\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <PageContainer>\r\n      <ProTable<Dept>\r\n        headerTitle=\"部门管理\"\r\n        actionRef={actionRef}\r\n        rowKey=\"dept_code\"\r\n        search={false}\r\n        toolBarRender={() => [\r\n          <Button\r\n            type=\"primary\"\r\n            key=\"primary\"\r\n            onClick={() => {\r\n              setCreateModalVisible(true);\r\n            }}\r\n          >\r\n            <PlusOutlined /> 新建\r\n          </Button>,\r\n        ]}\r\n        request={async () => {\r\n          const res = await getDeptTree();\r\n          if (res.code === 200 && res.data) {\r\n            // Flatten tree for table display\r\n            const flatten = (depts: Dept[]): Dept[] => {\r\n              const result: Dept[] = [];\r\n              depts.forEach((dept) => {\r\n                result.push(dept);\r\n                if (dept.children && dept.children.length > 0) {\r\n                  result.push(...flatten(dept.children));\r\n                }\r\n              });\r\n              return result;\r\n            };\r\n            return {\r\n              data: flatten(res.data),\r\n              success: true,\r\n              total: flatten(res.data).length,\r\n            };\r\n          }\r\n          return {\r\n            data: [],\r\n            success: false,\r\n            total: 0,\r\n          };\r\n        }}\r\n        columns={columns}\r\n        pagination={false}\r\n      />\r\n\r\n      <DeptForm\r\n        visible={createModalVisible}\r\n        onCancel={() => setCreateModalVisible(false)}\r\n        onSubmit={handleCreate}\r\n        title=\"新建部门\"\r\n      />\r\n\r\n      {editingRecord && (\r\n        <DeptForm\r\n          visible={updateModalVisible}\r\n          onCancel={() => {\r\n            setUpdateModalVisible(false);\r\n            setEditingRecord(null);\r\n          }}\r\n          onSubmit={handleUpdate}\r\n          title=\"编辑部门\"\r\n          initialValues={editingRecord}\r\n        />\r\n      )}\r\n    </PageContainer>\r\n  );\r\n};\r\n\r\nexport default DeptManagement;\r\n\r\n"],"names":[],"mappings":"6gBAmCO,eAAe,IACpB,MAAO,GAAA,SAAO,EAIX,4BAA6B,CAC9B,OAAQ,KACV,GACF,CAcO,eAAe,EAAW,CAAuB,EACtD,MAAO,GAAA,SAAO,EAIX,uBAAwB,CACzB,OAAQ,OACR,KAAA,CACF,GACF,CAGO,eAAe,EAAW,CAAgB,CAAE,CAAuB,EACxE,MAAO,GAAA,SAAO,EAIX,CAAC,qBAAqB,EAAE,EAAS,CAAC,CAAE,CACrC,OAAQ,MACR,KAAA,CACF,GACF,CAGO,eAAe,EAAW,CAAgB,EAC/C,MAAO,GAAA,SAAO,EAIX,CAAC,qBAAqB,EAAE,EAAS,CAAC,CAAE,CACrC,OAAQ,QACV,GACF,uEC5EA,IAAM,EAAoC,CAAC,CACzC,QAAA,CAAO,CACP,SAAA,CAAQ,CACR,SAAA,CAAQ,CACR,MAAA,CAAK,CACL,cAAA,CAAa,CACd,IACC,IAAM,EAAS,CAAC,CAAC,EAGX,EAAwB,GAAA,SAAO,EAAC,IAC7B,EAAgB,CAAE,GAAG,CAAa,AAAC,EAAI,KAAA,EAC7C,CAAC,EAAc,EAElB,MACE,UAAC,SAAK,EACJ,MAAO,EACP,KAAM,EACN,SAAU,EACV,OAAQ,KACR,MAAO,aAEP,WAAC,SAAO,EAEN,cAAe,EACf,SAAU,MAAO,IACf,EAAS,GACX,EACA,UAAW,CACT,OAAQ,CAAC,EAAO,IACP,CACL,UAAC,SAAM,EAAc,QAAS,WAAU,gBAA5B,UAGZ,UAAC,SAAM,EAAc,KAAK,UAAU,QAAS,SAAM,EAAA,iBAAA,EAAA,EAAM,IAAI,YAAV,iBAAA,EAAA,EAAY,MAAM,YAAlB,SAAA,OAAA,cAAwB,gBAA/D,UAGb,AAEL,YAEC,CAAC,GACA,UAAC,SAAW,EACV,KAAK,YACL,MAAM,2BACN,MAAO,CAAC,CAAE,SAAU,CAAA,EAAM,QAAS,4CAAU,EAAE,GAGnD,UAAC,SAAW,EAAC,KAAK,cAAc,MAAM,mCACrC,CAAC,GACA,UAAC,SAAW,EACV,KAAK,YACL,MAAM,2BACN,MAAO,CAAC,CAAE,SAAU,CAAA,EAAM,QAAS,4CAAU,EAAE,GAGlD,GAAU,UAAC,SAAW,EAAC,KAAK,YAAY,MAAM,6BAC/C,UAAC,SAAa,EACZ,KAAK,SACL,MAAM,eACN,QAAS,CACP,CAAE,MAAO,eAAM,MAAO,CAAE,EACxB,CAAE,MAAO,eAAM,MAAO,CAAE,EACzB,KAxCE,QAAS,SAAA,EAAe,SAAS,CAAG,YA6CjD,ECjEM,EAA2B,KAC/B,GAAM,CAAC,EAAoB,EAAsB,CAAG,GAAA,UAAQ,EAAC,CAAA,GACvD,CAAC,EAAoB,EAAsB,CAAG,GAAA,UAAQ,EAAC,CAAA,GACvD,CAAC,EAAe,EAAiB,CAAG,GAAA,UAAQ,EAAc,MAC1D,EAAY,GAAA,QAAM,IAElB,EAAe,MAAO,IAC1B,GAAI,CACF,IAAM,EAAM,MAAM,EAAW,GAC7B,GAAI,AAAa,MAAb,EAAI,IAAI,CAAU,KAGpB,EAFA,SAAO,CAAC,OAAO,CAAC,4BAChB,EAAsB,CAAA,WACtB,EAAA,EAAU,OAAO,YAAjB,GAAA,EAAmB,MAAM,GAC3B,MACE,SAAO,CAAC,KAAK,CAAC,EAAI,OAAO,EAAI,4BAEjC,CAAE,MAAO,EAAO,CACd,SAAO,CAAC,KAAK,CAAC,4BAChB,CACF,EAEM,EAAe,MAAO,IAC1B,GAAK,EACL,GAAI,CACF,IAAM,EAAM,MAAM,EAAW,EAAc,SAAS,CAAE,GACtD,GAAI,AAAa,MAAb,EAAI,IAAI,CAAU,KAIpB,EAHA,SAAO,CAAC,OAAO,CAAC,4BAChB,EAAsB,CAAA,GACtB,EAAiB,cACjB,EAAA,EAAU,OAAO,YAAjB,GAAA,EAAmB,MAAM,GAC3B,MACE,SAAO,CAAC,KAAK,CAAC,EAAI,OAAO,EAAI,4BAEjC,CAAE,MAAO,EAAO,CACd,SAAO,CAAC,KAAK,CAAC,4BAChB,CACF,EAEM,EAAe,AAAC,IACpB,SAAK,CAAC,OAAO,CAAC,CACZ,MAAO,2BACP,QAAS,CAAC,0DAAS,EAAE,EAAO,SAAS,CAAC,kBAAI,CAAC,CAC3C,KAAM,UACJ,GAAI,CACF,IAAM,EAAM,MAAM,EAAW,EAAO,SAAS,EAC7C,GAAI,AAAa,MAAb,EAAI,IAAI,CAAU,KAEpB,EADA,SAAO,CAAC,OAAO,CAAC,oCAChB,EAAA,EAAU,OAAO,YAAjB,GAAA,EAAmB,MAAM,GAC3B,MACE,SAAO,CAAC,KAAK,CAAC,EAAI,OAAO,EAAI,4BAEjC,CAAE,MAAO,EAAO,CACd,SAAO,CAAC,KAAK,CAAC,4BAChB,CACF,CACF,GACF,EAEM,EAA8B,CAClC,CACE,MAAO,2BACP,UAAW,YACX,IAAK,YACL,MAAO,GACT,EACA,CACE,MAAO,2BACP,UAAW,YACX,IAAK,YACL,MAAO,GACT,EACA,CACE,MAAO,iCACP,UAAW,cACX,IAAK,cACL,MAAO,GACT,EACA,CACE,MAAO,eACP,UAAW,SACX,IAAK,SACL,MAAO,GACP,UAAW,CACT,EAAG,CAAE,KAAM,eAAM,OAAQ,SAAU,EACnC,EAAG,CAAE,KAAM,eAAM,OAAQ,OAAQ,CACnC,CACF,EACA,CACE,MAAO,eACP,IAAK,SACL,MAAO,IACP,MAAO,QACP,OAAQ,CAAC,EAAG,IACV,WAAC,SAAK,YACJ,UAAC,SAAM,EACL,KAAK,OACL,KAAK,QACL,QAAS,KACP,EAAiB,GACjB,EAAsB,CAAA,GACxB,WACD,iBAGD,UAAC,SAAM,EACL,KAAK,OACL,KAAK,QACL,MAAM,IACN,QAAS,IAAM,EAAa,YAC7B,mBAKP,EACD,CAED,MACE,WAAC,eAAa,YACZ,UAAC,UAAQ,EACP,YAAY,2BACZ,UAAW,EACX,OAAO,YACP,OAAQ,CAAA,EACR,cAAe,IAAM,CACnB,WAAC,SAAM,EACL,KAAK,UAEL,QAAS,KACP,EAAsB,CAAA,GACxB,YAEA,UAAC,SAAY,KAAG,kBALZ,WAOP,CACD,QAAS,UACP,IAAM,EAAM,MAAM,IAClB,GAAI,AAAa,MAAb,EAAI,IAAI,EAAY,EAAI,IAAI,CAAE,CAEhC,IAAM,EAAU,AAAC,IACf,IAAM,EAAiB,EAAE,CAOzB,OANA,EAAM,OAAO,CAAC,AAAC,IACb,EAAO,IAAI,CAAC,GACR,EAAK,QAAQ,EAAI,EAAK,QAAQ,CAAC,MAAM,CAAG,GAC1C,EAAO,IAAI,IAAI,EAAQ,EAAK,QAAQ,GAExC,GACO,EACT,EACA,MAAO,CACL,KAAM,EAAQ,EAAI,IAAI,EACtB,QAAS,CAAA,EACT,MAAO,EAAQ,EAAI,IAAI,EAAE,MAAM,AACjC,EACF,CACA,MAAO,CACL,KAAM,EAAE,CACR,QAAS,CAAA,EACT,MAAO,CACT,EACF,EACA,QAAS,EACT,WAAY,CAAA,IAGd,UAAC,GACC,QAAS,EACT,SAAU,IAAM,EAAsB,CAAA,GACtC,SAAU,EACV,MAAM,6BAGP,GACC,UAAC,GACC,QAAS,EACT,SAAU,KACR,EAAsB,CAAA,GACtB,EAAiB,MACnB,EACA,SAAU,EACV,MAAM,2BACN,cAAe,OAKzB"}