# 诗语通用管理系统脚手架 - 项目设计总结

## 项目概述

**项目名称**: Shiyu Admin Scaffold (诗语通用管理系统脚手架)

**项目定位**: 一个基于Go语言的企业级后台管理系统基础框架，提供完整的用户权限管理、模块化架构和现代化的前端界面。

## 核心设计理念

### 1. 统一响应格式
所有API接口统一返回标准格式，包含三个字段：code表示状态码，data包含返回数据，message提供操作说明信息。这种统一格式使前端能够一致地处理所有API响应。

### 2. 分层架构
采用清晰的四层架构设计：Controller API层负责处理HTTP请求，Service业务逻辑层处理核心业务，Repository数据访问层负责数据库操作，Model数据模型层定义数据结构。各层之间通过接口解耦，确保低耦合高内聚。

### 3. 数据库兼容性设计
- **不使用数据库特定功能**: 避免PostgreSQL的JSON、数组等特性
- **标准SQL类型**: 仅使用PostgreSQL和MySQL共同支持的数据类型
- **主键策略**: 
  - 使用自增ID作为主键（性能优化）
  - 使用业务ID（如user_code）进行表关联（便于迁移）

### 4. 模块化设计
- **插件式架构**: 支持业务模块的低成本扩展
- **接口驱动**: 通过接口解耦各个模块
- **依赖注入**: 使用容器管理组件依赖关系

## 技术栈选型

### 后端技术栈
| 技术 | 版本 | 用途 |
|------|------|------|
| Go | 1.21+ | 主要编程语言 |
| Gin | 1.9+ | Web框架 |
| GORM | 1.25+ | ORM框架 |
| PostgreSQL | 12+ | 主数据库 |
| Redis | 6+ | 缓存和会话 |
| JWT | v5 | 身份认证 |
| Zap | 1.26+ | 结构化日志 |
| Viper | 1.18+ | 配置管理 |

### 前端技术栈
| 技术 | 用途 |
|------|------|
| Ant Design Pro React | 管理后台界面 |
| Vue3 + Vant | 移动端H5界面 |

#### 前端项目创建方式
**管理后台**: 使用Ant Design Pro官方脚手架命令创建项目，确保使用最新的官方模板和最佳实践。通过官方CLI工具可以快速搭建包含完整功能的管理后台框架，包括路由配置、权限控制、布局组件等开箱即用的功能。

**移动端H5**: 使用Vue3配合Vant UI组件库创建移动端项目，提供适配移动设备的用户界面和交互体验。

## 核心功能模块

### 1. 权限管理系统（基于若依RBAC设计）

#### 若依权限体系介绍
若依（RuoYi）是一个成熟的开源后台管理系统，采用经典的RBAC（基于角色的访问控制）模型。本项目借鉴了若依的权限设计思想，包括用户-角色-菜单的三层权限结构、数据权限范围控制、以及部门组织架构管理等核心功能。

若依的权限体系具有以下特点：
- **菜单权限**：支持目录、菜单、按钮三级权限控制，可以精确控制用户能看到哪些菜单和能执行哪些操作
- **数据权限**：支持全部数据、部门数据、部门及以下数据、仅本人数据等多种数据范围控制
- **角色管理**：通过角色作为权限的载体，用户通过分配角色获得相应权限
- **部门管理**：支持树形组织架构，配合数据权限实现数据隔离

#### 核心数据模型
系统包含四个核心实体：用户、角色、菜单和部门。每个实体都使用自增ID作为主键，同时使用业务ID进行表关联以支持数据库迁移。用户密码采用BCrypt加密存储，确保安全性。

用户实体包含基本信息如用户名、昵称、邮箱、手机号等，并关联到部门。角色实体定义了角色名称、角色标识和数据权限范围。菜单实体支持树形结构，包含目录、菜单和按钮三种类型，每个菜单可以设置权限标识。部门实体也支持树形结构，用于组织架构管理。

#### 关联关系
系统通过三个关联表实现多对多关系：用户与角色的关联、角色与菜单的关联、角色与部门的关联（用于数据权限控制）。这种设计使得权限分配灵活且易于管理。

#### 权限验证流程
用户登录后，系统会加载该用户的所有角色及对应的菜单权限，并缓存到Redis中。当用户访问某个功能时，系统会检查该用户是否拥有对应的权限标识。对于数据查询操作，系统会根据用户的数据权限范围自动过滤数据，确保用户只能看到权限范围内的数据。

#### 权限控制层级
1. **菜单权限**: 目录 → 菜单 → 按钮
2. **数据权限**: 
   - 全部数据权限
   - 部门数据权限
   - 部门及以下数据权限
   - 仅本人数据权限

### 2. 认证授权机制

#### JWT认证流程
用户登录时，系统首先验证用户名和密码，验证通过后生成JWT令牌，同时将用户权限信息缓存到Redis中，然后将令牌返回给客户端。客户端在后续请求中携带该令牌，服务器验证令牌有效性并获取用户权限，最后执行权限检查决定是否允许访问。

#### 安全特性
- 密码BCrypt加密存储
- JWT令牌过期和刷新机制
- 登录日志记录
- 异常登录检测
- 会话超时管理

### 3. 日志监控系统

#### 日志类型
- **请求日志**: 记录所有API调用（请求详情、响应状态、执行时间）
- **错误日志**: 捕获详细错误信息（堆栈跟踪、上下文）
- **审计日志**: 用户操作追踪（安全合规）
- **系统日志**: 应用运行状态

#### 日志特性
- 结构化日志格式（JSON）
- 可配置日志级别
- 日志轮转和归档
- 性能监控指标

## 项目目录结构

```
shiyu-admin-scaffold/
├── backend/                      # Go后端项目
│   ├── cmd/
│   │   └── server/
│   │       └── main.go          # 应用入口
│   ├── internal/                # 内部代码
│   │   ├── api/                # API控制器层
│   │   │   └── v1/
│   │   │       ├── system/     # 系统模块API
│   │   │       └── common/     # 通用API
│   │   ├── service/            # 业务逻辑层
│   │   │   ├── system/
│   │   │   └── interfaces/     # 服务接口定义
│   │   ├── repository/         # 数据访问层
│   │   │   ├── system/
│   │   │   └── interfaces/     # 仓储接口定义
│   │   ├── model/              # 数据模型
│   │   │   ├── entity/         # 实体模型
│   │   │   ├── dto/            # 数据传输对象
│   │   │   └── vo/             # 视图对象
│   │   ├── middleware/         # 中间件
│   │   ├── config/             # 配置管理
│   │   └── server/             # 服务器
│   ├── pkg/                    # 公共包
│   │   ├── response/           # 统一响应
│   │   ├── logger/             # 日志
│   │   ├── database/           # 数据库
│   │   ├── redis/              # 缓存
│   │   ├── jwt/                # JWT工具
│   │   └── validator/          # 验证器
│   ├── migrations/             # 数据库迁移
│   ├── configs/                # 配置文件
│   │   └── config.yaml
│   ├── scripts/                # 脚本文件
│   ├── go.mod
│   ├── Makefile
│   └── README.md
├── frontend/
│   ├── admin-web/              # Ant Design Pro管理后台
│   └── mobile-h5/              # Vue3移动端H5
├── docs/                       # 项目文档
└── README.md                   # 项目总体说明
```

## 核心设计模式

### 1. 依赖注入容器
系统使用依赖注入容器统一管理所有服务和仓储实例。容器负责创建和维护各个组件的生命周期，包括用户服务、角色服务、菜单服务等业务服务，以及对应的数据访问仓储。通过容器管理依赖关系，实现了组件间的松耦合。

### 2. 接口驱动开发
系统采用接口驱动的开发方式，所有服务层和仓储层都定义了清晰的接口。服务接口定义了业务操作方法，如创建、更新、删除、查询等。仓储接口定义了数据访问方法。这种设计使得实现可以灵活替换，便于单元测试和系统扩展。

### 3. 模块注册机制
系统提供了模块注册机制，支持业务模块的插件式扩展。每个模块需要实现模块接口，包括模块名称、版本信息、路由注册、服务注册、权限定义和数据库迁移等方法。新模块只需实现接口并注册到模块管理器即可自动集成到系统中。

## 数据库设计原则

### 1. 兼容性优先
- 使用标准SQL数据类型
- 避免数据库特定功能
- 支持PostgreSQL和MySQL

### 2. 主键和关联策略
系统采用双ID策略：使用自增ID作为主键以获得更好的性能，同时为每个实体生成唯一的业务ID用于表关联。这种设计既保证了数据库性能，又使得数据迁移更加容易，因为业务ID在不同数据库间保持不变。

### 3. 软删除
所有表都包含删除时间字段，支持软删除功能。删除操作只是标记删除时间而不是物理删除数据，这样可以保留数据历史并支持数据恢复。

## API设计规范

### 1. RESTful风格
系统API遵循RESTful设计规范，使用标准的HTTP方法：GET用于查询操作（获取列表和单个资源），POST用于创建操作，PUT用于更新操作，DELETE用于删除操作。URL路径清晰地表达资源层级关系，使API易于理解和使用。

### 2. 统一响应格式
系统定义了三种标准响应格式：成功响应返回code为200、包含数据和成功消息；错误响应返回非200的错误码、空数据和错误描述；验证错误返回code为422、在data中包含具体的字段验证错误信息。这种统一格式使前端能够一致地处理各种响应情况。

### 3. 错误代码规范
| 代码 | 说明 |
|------|------|
| 200 | 成功 |
| 400 | 请求错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 422 | 验证失败 |
| 500 | 服务器内部错误 |
| 501 | 数据库错误 |
| 502 | 外部服务错误 |

## 中间件系统

### 1. 日志中间件
- 记录所有请求信息
- 计算请求处理时间
- 根据状态码选择日志级别

### 2. CORS中间件
- 支持跨域请求
- 配置允许的请求头和方法
- 支持预检请求

### 3. 错误处理中间件
- 统一错误响应格式
- 区分业务错误和系统错误
- 自动处理验证错误

### 4. 认证中间件（待实现）
- JWT令牌验证
- 用户身份识别
- 权限检查

## 配置管理

### 配置文件结构
系统使用YAML格式的配置文件，包含服务器配置（端口、模式、超时时间）、数据库配置（驱动、连接信息、时区）、Redis配置（连接信息、数据库编号）、JWT配置（密钥、过期时间、签发者）和日志配置（级别、格式）等模块。配置文件结构清晰，易于维护和部署。

### 配置优先级
1. 环境变量（最高优先级）
2. 配置文件
3. 默认值

## 部署方案

### 1. Docker容器化
系统支持Docker容器化部署，采用多阶段构建方式。第一阶段使用Go官方镜像编译应用，第二阶段使用轻量级Alpine镜像运行应用，大幅减小最终镜像体积。容器化部署使得应用可以在不同环境中一致运行。

### 2. 环境配置
系统支持多环境配置：开发环境使用本地配置便于调试，测试环境使用测试服务器配置进行集成测试，生产环境通过环境变量配置确保安全性。配置优先级为环境变量、配置文件、默认值。

### 3. 健康检查
系统提供健康检查接口，返回服务状态和当前时间戳。该接口可用于容器编排工具（如Kubernetes）监控服务健康状态，实现自动重启和负载均衡。

## 开发规范

### 1. 代码规范
- 遵循Go官方代码规范
- 使用golangci-lint进行代码检查
- 统一使用gofmt格式化代码

### 2. 命名规范
- 包名：小写，简短，有意义
- 接口名：以er结尾（如UserService）
- 结构体：大驼峰命名
- 变量/函数：小驼峰命名

### 3. 注释规范
- 所有导出的类型、函数都要有注释
- 注释以类型/函数名开头
- 复杂逻辑要有详细注释

### 4. 错误处理
- 使用errors.New或fmt.Errorf创建错误
- 使用%w包装错误以保留错误链
- 不要忽略错误

## 测试策略

### 1. 单元测试
- 测试具体示例和边界情况
- 测试组件间的集成点
- 使用testify库进行断言

### 2. 基于属性的测试
- 验证通用属性
- 使用gopter库
- 每个属性测试运行100+次迭代

### 3. 集成测试
- API端到端测试
- 数据库事务测试
- 权限系统集成测试

## 扩展性设计

### 1. 添加新业务模块
系统支持插件式的模块扩展。开发者只需定义一个实现模块接口的结构体，实现模块名称、路由注册、服务注册等方法，然后将模块注册到模块管理器即可。新模块会自动集成到系统中，无需修改核心代码。

### 2. 添加新API接口
添加新API接口遵循标准流程：首先在实体层定义数据模型，然后在仓储层实现数据访问逻辑，接着在服务层实现业务逻辑，最后在API层实现控制器并注册路由。这种分层方式使得新功能的添加结构清晰、易于维护。

### 3. 添加新权限
添加新权限非常简单：在菜单表中添加权限定义（包括权限标识、菜单类型等），然后在代码中使用该权限标识进行权限检查。权限系统会自动识别新权限并在用户登录时加载，无需额外配置。

## 性能优化

### 1. 数据库优化
- 合理使用索引
- 连接池配置
- 查询优化
- 读写分离（可选）

### 2. 缓存策略
- 用户权限缓存到Redis
- 热点数据缓存
- 缓存过期策略

### 3. 并发处理
- Go协程处理异步任务
- 使用context控制超时
- 合理使用锁机制

## 安全措施

### 1. 认证安全
- 密码BCrypt加密
- JWT令牌机制
- 令牌过期和刷新
- 防止暴力破解

### 2. 授权安全
- 基于角色的访问控制
- 数据权限隔离
- 操作权限验证
- 审计日志记录

### 3. 数据安全
- SQL注入防护（GORM参数化查询）
- XSS防护
- CSRF防护
- 敏感数据加密

### 4. 网络安全
- HTTPS传输
- CORS配置
- 请求频率限制
- IP白名单（可选）

## 落地检查清单

- 认证中间件落地：鉴权拦截器接口约定、未登录/过期/权限不足返回格式、JWT 刷新/续签策略、错误码统一。
- 权限缓存失效：角色/菜单变更后的 Redis 失效与重建机制（版本号或事件驱动），缓存过期时间配置。
- 前端鉴权与菜单：Ant Design Pro / 移动端的菜单树加载、路由守卫、权限点校验、无权限跳转/提示规范。
- 日志与审计：日志字段规范（traceId/userId/action/resource）、敏感字段脱敏、采样策略、慢请求阈值、归档与查询栈（如 ELK/Loki/ClickHouse）。
- 健康检查：liveness/readiness 区分，依赖自检（DB/Redis/迁移状态），是否需要鉴权。
- 配置与密钥管理：JWT secret、DB 密码等敏感信息的环境变量/密钥管理方案，多环境差异化配置策略。
- 测试目标：关键用例清单（权限边界、缓存一致性、JWT 刷新、并发写入、典型 SQL 性能），覆盖率或质量门禁要求。
- 数据库与性能：常用索引/查询示例，连接池默认值，分页排序策略，读写分离或分库分表的触发条件。
- 未来规划的里程碑：短/中/长期事项增加优先级或时间框（周/月），便于排期跟踪。

## 未来规划

### 短期目标
- [ ] 完成核心权限系统
- [ ] 实现用户、角色、菜单管理
- [ ] 完成JWT认证授权
- [ ] 搭建前端管理界面

### 中期目标
- [ ] 实现代码生成器
- [ ] 完善日志监控系统
- [ ] 添加文件上传功能
- [ ] 实现WebSocket实时通知

### 长期目标
- [ ] 微服务架构支持
- [ ] 多租户支持
- [ ] 国际化支持
- [ ] 移动端完整功能

## 总结

诗语通用管理系统脚手架是一个设计精良、架构清晰、易于扩展的企业级后台管理系统基础框架。通过采用现代化的技术栈、清晰的分层架构、完善的权限系统和模块化设计，为快速开发企业级管理应用提供了坚实的基础。

核心优势：
1. **统一规范**: 统一的响应格式和API设计
2. **低耦合**: 清晰的分层和接口驱动设计
3. **易扩展**: 模块化架构支持业务快速扩展
4. **数据库兼容**: 支持PostgreSQL和MySQL无缝迁移
5. **完整权限**: 基于若依的成熟RBAC权限体系
6. **安全可靠**: 完善的认证授权和安全措施

该脚手架适用于各类企业级管理系统的快速开发，可以大幅降低项目初期的架构设计和基础功能开发成本。