# 诗语通用管理系统脚手架 - 需求与技术方案（架构师草稿）

## 1. 目标与范围
- 构建企业级后台管理脚手架，支持用户/角色/菜单的 RBAC 权限体系，兼容 PostgreSQL/MySQL。
- 提供模块化、插件式扩展能力，便于快速添加业务模块和权限点。
- 交付前后端一体的可运行基线：后端 Go 服务、管理后台（Ant Design Pro）、移动端 H5（Vue3 + Vant）。

## 2. 核心需求
- 认证授权：JWT 登录、刷新，基于角色+菜单+按钮的权限控制，数据权限（全部/部门/部门及以下/本人）。
- 权限管理：用户、角色、菜单、部门的增删改查；权限点绑定与缓存；审计日志。
- 权限模型参考若依：沿用用户/角色/菜单/部门的表设计与三表关联（用户-角色、角色-菜单、角色-部门）以快速落地 RBAC 与数据权限。
- 日志与监控：请求/错误/审计日志，慢请求阈值，结构化输出，采样与脱敏。
- 配置管理：多环境配置（dev/test/prod），敏感信息由环境变量/密钥管理；统一响应格式和错误码。
- 健康检查：liveness/readiness，依赖检查（DB/Redis/迁移状态），可被容器编排使用。
- 缓存策略：权限与热点数据缓存，失效/刷新机制（角色/菜单变更触发）。
- 部署与交付：Docker 多阶段构建，轻量运行时镜像；提供基础 Makefile/脚本。
- 测试与质量：单元/集成测试覆盖关键路径（认证、权限、缓存一致性、SQL 性能），质量门禁可配置。

## 3. 技术选型与约束
- 后端：Go 1.21+，Gin，GORM，Zap，Viper，JWT(v5)；数据库 PostgreSQL 12+ / MySQL 兼容；Redis 6+。
- 前端：Ant Design Pro React（后台），Vue3 + Vant（移动端）；路由守卫与菜单按权限加载。
- 设计约束：遵循分层架构（Controller/Service/Repository/Model），接口驱动，依赖注入；统一响应与错误码；避免数据库特有类型，使用自增 ID + 业务 ID 双 ID 策略；软删除。

## 4. 关键技术点与实现要点
- 认证中间件：JWT 校验、续签/刷新策略；未登录/过期/权限不足的统一返回格式与错误码。
- 权限缓存：用户登录后加载角色/菜单权限入 Redis；角色/菜单更新的失效与重建（版本号或事件驱动），TTL 配置。
- 数据权限：基于角色的数据范围过滤（全部/部门/部门及以下/本人），在查询层注入过滤条件。
- 前端鉴权：登录后拉取菜单树和权限点；路由守卫；无权限提示/跳转规范；按钮级权限指令/组件。
- 日志与审计：字段规范（traceId/userId/action/resource）；敏感字段脱敏；采样策略；慢请求阈值；对接日志栈（ELK/Loki/ClickHouse 按环境选型）。
- 配置安全：JWT secret、DB 密码等通过环境变量/Secret 管理；本地/测试/生产差异化加载；配置优先级（env > 配置文件 > 默认）。
- 健康检查：区分 liveness/readiness，检查 DB/Redis 连接与迁移状态；是否开放鉴权。
- 数据库与性能：索引策略与示例；连接池默认值；分页/排序策略；可选读写分离或分库分表触发条件。
- 模块扩展：模块接口（Name/Version/RegisterRoutes/RegisterServices/RegisterPermissions/Migrate）；模块迁移顺序与幂等性；前端权限同步约定。

## 5. 里程碑（建议）
- M1（1-2 周）：搭建后端骨架与核心中间件（认证/日志/CORS/错误处理），完成用户/角色/菜单/部门基础 CRUD 与权限模型，JWT 登录与权限校验，健康检查。
- M2（2-3 周）：前端管理后台接入登录与菜单/路由守卫，权限点控制；权限缓存失效机制；基础审计日志；测试用例覆盖关键路径。
- M3（2 周）：移动端 H5 接入登录与基础菜单/权限；日志采样与脱敏；慢请求监控；CI/CD 基线（构建、测试、镜像、部署）。
- M4（2 周，可选）：代码生成器雏形、WebSocket 通知、文件上传；读写分离/性能优化；多环境配置与密钥管理完善。

## 6. 交付物
- 后端仓库：源码、配置示例、迁移脚本、Makefile/脚本、Dockerfile。
- 前端仓库：Admin Pro 与移动端 H5 源码、环境配置示例、构建脚本。
- 文档：架构与设计说明、落地检查清单、部署与运维手册、测试用例/报告。

## 7. 风险与关注点
- 权限缓存一致性与失效；数据权限过滤正确性。
- JWT 刷新与会话并发处理；防暴力破解与频控。
- 日志敏感信息脱敏；审计日志性能与存储成本。
- 多数据库兼容测试（PostgreSQL/MySQL）与迁移幂等。
- 前后端权限模型对齐（菜单/按钮标识的一致性）。

