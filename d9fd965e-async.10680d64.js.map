{"version":3,"sources":["src/services/shiyu-api/monitor.ts","src/pages/system/monitor/index.tsx"],"sourcesContent":["import { request } from '@umijs/max';\r\n\r\nexport interface CacheStats {\r\n  redis_version?: string;\r\n  mode?: string;\r\n  used_memory?: number;\r\n  used_memory_human?: string;\r\n  db_size?: number;\r\n  connected_clients?: number;\r\n  keyspace_hits?: number;\r\n  keyspace_misses?: number;\r\n  hit_rate?: number;\r\n}\r\n\r\nexport interface OnlineUser {\r\n  user_code: string;\r\n  username: string;\r\n  ip?: string;\r\n  user_agent?: string;\r\n  last_active: number;\r\n}\r\n\r\n/** 获取缓存监控数据 */\r\nexport async function getCacheStats() {\r\n  return request<{\r\n    code: number;\r\n    data: CacheStats;\r\n    message?: string;\r\n  }>('/api/v1/system/monitor/cache', {\r\n    method: 'GET',\r\n  });\r\n}\r\n\r\n/** 获取在线用户列表 */\r\nexport async function getOnlineUsers() {\r\n  return request<{\r\n    code: number;\r\n    data: OnlineUser[];\r\n    message?: string;\r\n  }>('/api/v1/system/monitor/online-users', {\r\n    method: 'GET',\r\n  });\r\n}\r\n","import type { ProColumns } from '@ant-design/pro-components';\r\nimport { PageContainer, ProCard, ProTable } from '@ant-design/pro-components';\r\nimport React from 'react';\r\nimport type { CacheStats, OnlineUser } from '@/services/shiyu-api/monitor';\r\nimport { getCacheStats, getOnlineUsers } from '@/services/shiyu-api/monitor';\r\n\r\nconst MonitorPage: React.FC = () => {\r\n  const onlineColumns: ProColumns<OnlineUser>[] = [\r\n    {\r\n      title: '用户编码',\r\n      dataIndex: 'user_code',\r\n      key: 'user_code',\r\n      width: 140,\r\n    },\r\n    {\r\n      title: '用户名',\r\n      dataIndex: 'username',\r\n      key: 'username',\r\n      width: 140,\r\n    },\r\n    {\r\n      title: 'IP',\r\n      dataIndex: 'ip',\r\n      key: 'ip',\r\n      width: 160,\r\n    },\r\n    {\r\n      title: 'User-Agent',\r\n      dataIndex: 'user_agent',\r\n      key: 'user_agent',\r\n      ellipsis: true,\r\n    },\r\n    {\r\n      title: '最后活跃时间',\r\n      dataIndex: 'last_active',\r\n      key: 'last_active',\r\n      width: 200,\r\n      render: (_: any, record: OnlineUser) => {\r\n        if (!record.last_active) return '-';\r\n        const d = new Date(record.last_active * 1000);\r\n        return d.toLocaleString();\r\n      },\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <PageContainer>\r\n      <ProCard title=\"缓存监控\" bordered style={{ marginBottom: 16 }}>\r\n        <ProTable<CacheStats>\r\n          rowKey=\"redis_version\"\r\n          search={false}\r\n          options={false}\r\n          pagination={false}\r\n          toolBarRender={false}\r\n          request={async () => {\r\n            const res = await getCacheStats();\r\n            if (res.code === 200 && res.data) {\r\n              return {\r\n                data: [res.data],\r\n                success: true,\r\n              };\r\n            }\r\n            return {\r\n              data: [],\r\n              success: false,\r\n            };\r\n          }}\r\n          columns={[\r\n            {\r\n              title: 'Redis 版本',\r\n              dataIndex: 'redis_version',\r\n              key: 'redis_version',\r\n              render: (text: string | undefined) => text || '-',\r\n            },\r\n            {\r\n              title: '模式',\r\n              dataIndex: 'mode',\r\n              key: 'mode',\r\n              render: (text: string | undefined) =>\r\n                text === 'cluster' ? '集群' : '单机',\r\n            },\r\n            {\r\n              title: '已用内存',\r\n              dataIndex: 'used_memory_human',\r\n              key: 'used_memory_human',\r\n              render: (text: string | undefined) => text || '-',\r\n            },\r\n            {\r\n              title: '键数量',\r\n              dataIndex: 'db_size',\r\n              key: 'db_size',\r\n            },\r\n            {\r\n              title: '连接数',\r\n              dataIndex: 'connected_clients',\r\n              key: 'connected_clients',\r\n            },\r\n            {\r\n              title: '命中率',\r\n              dataIndex: 'hit_rate',\r\n              key: 'hit_rate',\r\n              render: (value: number | undefined) => {\r\n                if (value === undefined || value === null) return '-';\r\n                const percent = Math.round(Number(value) * 10000) / 100;\r\n                return `${percent}%`;\r\n              },\r\n            },\r\n          ]}\r\n        />\r\n      </ProCard>\r\n\r\n      <ProCard title=\"在线用户\" bordered>\r\n        <ProTable<OnlineUser>\r\n          headerTitle=\"在线用户列表\"\r\n          rowKey=\"user_code\"\r\n          search={false}\r\n          toolBarRender={false}\r\n          request={async () => {\r\n            const res = await getOnlineUsers();\r\n            if (res.code === 200 && res.data) {\r\n              return {\r\n                data: res.data,\r\n                success: true,\r\n              };\r\n            }\r\n            return {\r\n              data: [],\r\n              success: false,\r\n            };\r\n          }}\r\n          columns={onlineColumns}\r\n        />\r\n      </ProCard>\r\n    </PageContainer>\r\n  );\r\n};\r\n\r\nexport default MonitorPage;\r\n"],"names":[],"mappings":"kZAuBO,eAAe,IACpB,MAAO,GAAA,SAAO,EAIX,+BAAgC,CACjC,OAAQ,KACV,GACF,CAGO,eAAe,IACpB,MAAO,GAAA,SAAO,EAIX,sCAAuC,CACxC,OAAQ,KACV,GACF,CCpCA,IAAM,EAAwB,KAC5B,IAAM,EAA0C,CAC9C,CACE,MAAO,2BACP,UAAW,YACX,IAAK,YACL,MAAO,GACT,EACA,CACE,MAAO,qBACP,UAAW,WACX,IAAK,WACL,MAAO,GACT,EACA,CACE,MAAO,KACP,UAAW,KACX,IAAK,KACL,MAAO,GACT,EACA,CACE,MAAO,aACP,UAAW,aACX,IAAK,aACL,SAAU,CAAA,CACZ,EACA,CACE,MAAO,uCACP,UAAW,cACX,IAAK,cACL,MAAO,IACP,OAAQ,CAAC,EAAQ,IACf,AAAK,EAAO,WAAW,CAEhB,AADG,IAAI,KAAK,AAAqB,IAArB,EAAO,WAAW,EAC5B,cAAc,GAFS,GAIpC,EACD,CAED,MACE,WAAC,eAAa,YACZ,UAAC,SAAO,EAAC,MAAM,2BAAO,QAAQ,IAAC,MAAO,CAAE,aAAc,EAAG,WACvD,UAAC,UAAQ,EACP,OAAO,gBACP,OAAQ,CAAA,EACR,QAAS,CAAA,EACT,WAAY,CAAA,EACZ,cAAe,CAAA,EACf,QAAS,UACP,IAAM,EAAM,MAAM,WAClB,AAAI,AAAa,MAAb,EAAI,IAAI,EAAY,EAAI,IAAI,CACvB,CACL,KAAM,CAAC,EAAI,IAAI,CAAC,CAChB,QAAS,CAAA,CACX,EAEK,CACL,KAAM,EAAE,CACR,QAAS,CAAA,CACX,EACF,EACA,QAAS,CACP,CACE,MAAO,qBACP,UAAW,gBACX,IAAK,gBACL,OAAQ,AAAC,GAA6B,GAAQ,GAChD,EACA,CACE,MAAO,eACP,UAAW,OACX,IAAK,OACL,OAAQ,AAAC,GACP,AAAS,YAAT,EAAqB,eAAO,cAChC,EACA,CACE,MAAO,2BACP,UAAW,oBACX,IAAK,oBACL,OAAQ,AAAC,GAA6B,GAAQ,GAChD,EACA,CACE,MAAO,qBACP,UAAW,UACX,IAAK,SACP,EACA,CACE,MAAO,qBACP,UAAW,oBACX,IAAK,mBACP,EACA,CACE,MAAO,qBACP,UAAW,WACX,IAAK,WACL,OAAQ,AAAC,IACP,GAAI,MAAA,EAAuC,MAAO,IAClD,IAAM,EAAU,KAAK,KAAK,CAAC,AAAgB,IAAhB,OAAO,IAAkB,IACpD,MAAO,CAAC,EAAE,EAAQ,CAAC,CAAC,CACtB,CACF,EACD,KAIL,UAAC,SAAO,EAAC,MAAM,2BAAO,QAAQ,aAC5B,UAAC,UAAQ,EACP,YAAY,uCACZ,OAAO,YACP,OAAQ,CAAA,EACR,cAAe,CAAA,EACf,QAAS,UACP,IAAM,EAAM,MAAM,WAClB,AAAI,AAAa,MAAb,EAAI,IAAI,EAAY,EAAI,IAAI,CACvB,CACL,KAAM,EAAI,IAAI,CACd,QAAS,CAAA,CACX,EAEK,CACL,KAAM,EAAE,CACR,QAAS,CAAA,CACX,EACF,EACA,QAAS,SAKnB"}